# SPEC-구현 평가 (2026-02-06)

## 1. 종합 판정
- `docs/spec_implementation_review_2026-02-06.md`의 기존 결론(정확도/회계 미달)은 현재 재실행 결과와 일치한다.
- 신규 목표인 `상시 coarse 저장 + 저에너지(E<=10MeV) fine scratch` 기준으로 보면, 현재 코드는 메모리 구조와 실행 정책이 크게 다르다.
- 권고 방향: `SPEC 재구성 + 저에너지 전용 fine-scratch 전환`을 병행한다.

## 2. 목표 구조 대비 적합성 평가

### 2.1 상시 coarse 저장 목표 대비 현재 구조
- 현재 실행 경로는 `psi_in`, `psi_out`를 full-grid로 항상 할당한다.
- pipeline state도 `OutflowBuckets`를 full-grid로 상시 할당한다.
- 즉, fine 영역이 작아도 메모리 이득이 거의 없는 dense 구조다.
- 근거:
  - `src/cuda/gpu_transport_wrapper.cu:197`
  - `src/cuda/gpu_transport_wrapper.cu:202`
  - `src/cuda/k1k6_pipeline.cu:622`

### 2.2 `E<=10 MeV` fine-only 목표 대비 현재 전이 규칙
- 현재 K1은 저에너지 블록 기반 활성화를 수행하므로 `fine=저에너지` 방향성 자체는 맞다.
- 하지만 coarse step 중 `E=10 MeV` 교차 지점에서의 강제 분할(crossing guard) 계약은 명시적 구현/검증이 부족하다.
- hysteresis(`E_on/E_off`) 정책도 아직 없다.
- 근거:
  - `src/cuda/kernels/k1_activemask.cu:35`
  - `src/cuda/kernels/k2_coarsetransport.cu:116`

### 2.3 보존형 fine->coarse 반영 목표 대비 현재 감사 체계
- K5는 아직 weight-only 감사이며 energy pass/fail을 커널에서 강제하지 못한다.
- 따라서 fine/coarse 경계에서의 에너지 회계 오차를 iteration 단위로 확정하기 어렵다.
- 근거:
  - `src/cuda/kernels/k5_audit.cuh:5`
  - `src/cuda/k1k6_pipeline.cu:1179`

## 3. 재검증 결과 (2026-02-06 재실행)

### 4.1 실행 명령
```bash
ctest --test-dir build -R "EnergyLossOnlyTest\.(EnergyLossOnly|FullPhysics|StragglingOnly|NuclearOnly)" --output-on-failure
```

### 4.2 결과 요약
- 4개 중 1개 통과, 3개 실패.
- 실패:
  - `EnergyLossOnlyTest.EnergyLossOnly`
  - `EnergyLossOnlyTest.FullPhysics`
  - `EnergyLossOnlyTest.StragglingOnly`

### 4.3 핵심 수치
- `EnergyLossOnly`:
  - `AccountedTotal = 145.673 MeV`, `Bragg depth = 90 mm`
- `FullPhysics`:
  - `AccountedTotal = 155.742 MeV`, `Bragg depth = 88 mm`
- `StragglingOnly`:
  - `AccountedTotal = 142.308 MeV`, `Bragg depth = 88 mm`
- `NuclearOnly`:
  - 통과

### 4.4 결론
- 기존 리뷰와 동일하게 Bragg depth 단축(기대 ~158mm 대비) 및 에너지 회계 오차가 지속된다.
- 근거:
  - `tests/gpu/test_energy_loss_only_gpu.cu:588`
  - `tests/gpu/test_energy_loss_only_gpu.cu:589`
  - `tests/gpu/test_energy_loss_only_gpu.cu:613`
  - `tests/gpu/test_energy_loss_only_gpu.cu:614`
  - `tests/gpu/test_energy_loss_only_gpu.cu:636`

## 4. 메모리/실행 시간 재측정 (RTX 2080 8GB)

### 5.1 기본 설정 실행 가능성
- 기본 `sim.ini`(`Nx=200`, `Nz=640`)는 OOM으로 실패한다.
- 관측 로그 기준 `psi_in` 1개만 약 4.0GB이며, `psi_out` 추가 할당에서 실패한다.

### 5.2 축소 프로파일 실측(출력 저장 off, `max_steps=200`)
- `120x200`: `91.197 s`
- `140x220`: `113.857 s`
- `160x240`: `149.461 s`

### 5.3 시사점
- 현재 dense 경로에서는 8GB 내 실행은 가능해도 목표 시간(수십초) 달성이 어렵다.
- fine을 저에너지에서만 scratch로 운용하는 메모리/스케줄 구조 전환이 필수다.

## 5. 기존 리뷰 문서와의 관계
- 본 문서는 `docs/spec_implementation_review_2026-02-06.md`를 부정하지 않는다.
- 차이는 다음 2점이다.
  - 기존 리뷰는 주로 “불일치/결함” 중심이다.
  - 본 문서는 여기에 더해 “저에너지 fine-scratch 목표 대비 구조 갭”과 “8GB 실측 시간”을 명시한다.
