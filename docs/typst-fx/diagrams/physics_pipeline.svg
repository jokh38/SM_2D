<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 750">
  <defs>
    <filter id="shadow">
      <feDropShadow dx="3" dy="3" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
    <linearGradient id="stepGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#6c5ce7;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#a29bfe;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="energyGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#e17055;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#fab1a0;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="stragGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#00b894;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#55efc4;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="mcsGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#0984e3;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#74b9ff;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="nucGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#d63031;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ff7675;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="depGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#fdcb6e;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ffeaa7;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="boundGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#636e72;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#b2bec3;stop-opacity:1" />
    </linearGradient>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#2d3436" />
    </marker>
  </defs>

  <!-- Background -->
  <rect width="700" height="750" fill="#f8f9fa" />

  <!-- Title -->
  <rect x="0" y="0" width="700" height="60" fill="#2d3436" />
  <text x="350" y="40" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="white" text-anchor="middle">
    Physics Pipeline (Per Particle Per Step)
  </text>

  <!-- Input -->
  <rect x="200" y="80" width="300" height="45" rx="8" fill="#2d3436" filter="url(#shadow)" />
  <text x="350" y="108" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="white" text-anchor="middle">
    INPUT: Particle (E, θ, x, z, W)
  </text>

  <!-- Arrow -->
  <line x1="350" y1="125" x2="350" y2="150" stroke="#2d3436" stroke-width="3" marker-end="url(#arrowhead)" />

  <!-- Step 1: Step Control -->
  <rect x="150" y="155" width="400" height="75" rx="10" fill="url(#stepGrad)" filter="url(#shadow)" />
  <circle cx="180" cy="192" r="20" fill="#fff" opacity="0.3" />
  <text x="180" y="200" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="white" text-anchor="middle">1</text>
  <text x="350" y="180" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white" text-anchor="middle">
    STEP CONTROL
  </text>
  <text x="350" y="205" font-family="Arial, sans-serif" font-size="13" fill="#f0f3ff" text-anchor="middle">
    "How far should we go?" ds = min(2% × R, dx, dz)
  </text>

  <!-- Arrow -->
  <line x1="350" y1="230" x2="350" y2="255" stroke="#2d3436" stroke-width="3" marker-end="url(#arrowhead)" />

  <!-- Step 2: Energy Loss -->
  <rect x="150" y="260" width="400" height="75" rx="10" fill="url(#energyGrad)" filter="url(#shadow)" />
  <circle cx="180" cy="297" r="20" fill="#fff" opacity="0.3" />
  <text x="180" y="305" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="white" text-anchor="middle">2</text>
  <text x="350" y="285" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white" text-anchor="middle">
    ENERGY LOSS
  </text>
  <text x="350" y="310" font-family="Arial, sans-serif" font-size="13" fill="#fff5f0" text-anchor="middle">
    E_new = E_old - (dE/ds) × ds (CSDA)
  </text>

  <!-- Arrow -->
  <line x1="350" y1="335" x2="350" y2="360" stroke="#2d3436" stroke-width="3" marker-end="url(#arrowhead)" />

  <!-- Step 3: Straggling -->
  <rect x="150" y="365" width="400" height="75" rx="10" fill="url(#stragGrad)" filter="url(#shadow)" />
  <circle cx="180" cy="402" r="20" fill="#fff" opacity="0.3" />
  <text x="180" y="410" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="white" text-anchor="middle">3</text>
  <text x="350" y="390" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white" text-anchor="middle">
    STRAGGLING
  </text>
  <text x="350" y="415" font-family="Arial, sans-serif" font-size="13" fill="#e6fff9" text-anchor="middle">
    ΔE ~ Vavilov(κ) (Statistical fluctuation)
  </text>

  <!-- Arrow -->
  <line x1="350" y1="440" x2="350" y2="465" stroke="#2d3436" stroke-width="3" marker-end="url(#arrowhead)" />

  <!-- Step 4: MCS -->
  <rect x="150" y="470" width="400" height="75" rx="10" fill="url(#mcsGrad)" filter="url(#shadow)" />
  <circle cx="180" cy="507" r="20" fill="#fff" opacity="0.3" />
  <text x="180" y="515" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="white" text-anchor="middle">4</text>
  <text x="350" y="495" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white" text-anchor="middle">
    MULTIPLE COULOMB SCATTERING
  </text>
  <text x="350" y="520" font-family="Arial, sans-serif" font-size="13" fill="#e6f2ff" text-anchor="middle">
    θ_new = θ_old + σ_θ × N(0,1) (Highland formula)
  </text>

  <!-- Arrow -->
  <line x1="350" y1="545" x2="350" y2="570" stroke="#2d3436" stroke-width="3" marker-end="url(#arrowhead)" />

  <!-- Step 5: Nuclear -->
  <rect x="150" y="575" width="400" height="75" rx="10" fill="url(#nucGrad)" filter="url(#shadow)" />
  <circle cx="180" cy="612" r="20" fill="#fff" opacity="0.3" />
  <text x="180" y="620" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="white" text-anchor="middle">5</text>
  <text x="350" y="600" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white" text-anchor="middle">
    NUCLEAR ATTENUATION
  </text>
  <text x="350" y="625" font-family="Arial, sans-serif" font-size="13" fill="#ffe6e6" text-anchor="middle">
    W_new = W_old × exp(-σ × ds) (Probabilistic)
  </text>

  <!-- Arrow split -->
  <line x1="350" y1="650" x2="350" y2="675" stroke="#2d3436" stroke-width="3" />
  <line x1="350" y1="675" x2="250" y2="700" stroke="#2d3436" stroke-width="3" marker-end="url(#arrowhead)" />
  <line x1="350" y1="675" x2="450" y2="700" stroke="#2d3436" stroke-width="3" marker-end="url(#arrowhead)" />

  <!-- Step 6a: Energy Deposition -->
  <rect x="50" y="705" width="280" height="40" rx="8" fill="url(#depGrad)" filter="url(#shadow)" />
  <text x="190" y="732" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#2d3436" text-anchor="middle">
    6. DEPOSITION: E_dep = E_in - E_out
  </text>

  <!-- Step 6b: Boundary Check -->
  <rect x="370" y="705" width="280" height="40" rx="8" fill="url(#boundGrad)" filter="url(#shadow)" />
  <text x="510" y="732" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="white" text-anchor="middle">
    7. BOUNDARY: Cell crossing check
  </text>

  <!-- Side note -->
  <rect x="580" y="150" width="110" height="480" rx="10" fill="#fff" stroke="#dfe6e9" stroke-width="2" />
  <text x="635" y="180" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#2d3436" text-anchor="middle">
    Key Points
  </text>

  <g transform="translate(590, 200)">
    <circle cx="10" cy="10" r="8" fill="#6c5ce7" />
    <text x="10" y="14" font-family="Arial" font-size="10" fill="white" text-anchor="middle">1</text>
    <text x="25" y="14" font-family="Arial" font-size="10" fill="#636e72">Adaptive step</text>

    <circle cx="10" cy="50" r="8" fill="#e17055" />
    <text x="10" y="54" font-family="Arial" font-size="10" fill="white" text-anchor="middle">2</text>
    <text x="25" y="54" font-family="Arial" font-size="10" fill="#636e72">NIST stopping</text>

    <circle cx="10" cy="90" r="8" fill="#00b894" />
    <text x="10" y="94" font-family="Arial" font-size="10" fill="white" text-anchor="middle">3</text>
    <text x="25" y="94" font-family="Arial" font-size="10" fill="#636e72">Vavilov model</text>

    <circle cx="10" cy="130" r="8" fill="#0984e3" />
    <text x="10" y="134" font-family="Arial" font-size="10" fill="white" text-anchor="middle">4</text>
    <text x="25" y="134" font-family="Arial" font-size="10" fill="#636e72">Highland MCS</text>

    <circle cx="10" cy="170" r="8" fill="#d63031" />
    <text x="10" y="174" font-family="Arial" font-size="10" fill="white" text-anchor="middle">5</text>
    <text x="25" y="174" font-family="Arial" font-size="10" fill="#636e72">ICRU 63 nuclear</text>

    <circle cx="10" cy="210" r="8" fill="#fdcb6e" />
    <text x="10" y="214" font-family="Arial" font-size="10" fill="#2d3436" text-anchor="middle">6</text>
    <text x="25" y="214" font-family="Arial" font-size="10" fill="#636e72">Dose output</text>

    <circle cx="10" cy="250" r="8" fill="#636e72" />
    <text x="10" y="254" font-family="Arial" font-size="10" fill="white" text-anchor="middle">7</text>
    <text x="25" y="254" font-family="Arial" font-size="10" fill="#636e72">Bucket emit</text>
  </g>

  <!-- Bottom note -->
  <text x="350" y="770" font-family="Arial, sans-serif" font-size="11" fill="#636e72" text-anchor="middle">
    This pipeline runs for EVERY particle in EVERY active cell at EVERY transport step
  </text>
</svg>
